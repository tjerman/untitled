---
title: "Moving our money tracking back-end to the cloud"
date: 2022-02-12T16:28:49+01:00
tags: [development,Flutter,Corteza,afternoon-project]
---

This project is the result of my experimentation with mobile development.
Do keep this in mind if you decide to follow my instructions to implement your mobile app.
The concepts are there, but some Flutter related specifics may not be that *by the book*.

The source code is available on [GitHub/tjerman/money](https://github.com/tjerman/money/tree/planet-crust).

# Moving to Planet Crust

**Disclosure** I am a core Corteza contributor, and I work with Planet Crust.

To move to Planet Crust we firstly need to create an account.
Go to https://www.planetcrust.com/ and click on the "get started for free" button in the top-right corner

![Screenshot](/money-planet-crust/planet-crust-home.png)

we wish to use Corteza in the cloud so click on the "free online trial" for Corteza Cloud

![Screenshot](/money-planet-crust/planet-crust-getting-started.png)

type in your details in the signup form.

![Screenshot](/money-planet-crust/planet-crust-account.png)

At this point, your cloud instance is being prepared (which can take a few minutes).
If you need, you can schedule a demo to get an introduction.

![Screenshot](/money-planet-crust/planet-crust-account-created.png)

After that step, we're done.
We need to wait for the automated welcome email with a link to our instance.

![Screenshot](/money-planet-crust/planet-crust-done.png)

# Preparing the cloud Corteza instance

After receiving the automated welcome email, we can get started with the fun bits.
Click on the link to navigate your cloud instance and set a password for your user.

Once finished, click on the tiny dots icon in the top-right corner to navigate the app selector.

![Screenshot](/money-planet-crust/login-profile.png)

We'll start with Low Code stuff, so click on the Low Code application.

![Screenshot](/money-planet-crust/app-selector-compose.png)

Click on the "import namespace" button and drop in the `.zip` archive (you can use <a href="/money/money.zip">the one I prepared</a> or you can export your own).

![Screenshot](/money-planet-crust/namespace-list.png)

After you've imported the namespace, it will show up in the list of namespaces.
Click on the "visit namespace" button and make sure everything is as it should be.

![Screenshot](/money-planet-crust/namespace-imported.png)

Next, add a few transactions we'll use for testing later on (I sure wish that my test transaction was actual test data...).

![Screenshot](/money-planet-crust/namespace-transactions.png)

Next, we'll deal with authentication-related stuff, so navigate back to the app selector and click on the "admin area" application.

![Screenshot](/money-planet-crust/app-selector-admin.png)

Navigate to "auth clients" and create an auth client just like last time.
Refer to the [previous post]({{< ref "money" >}}) if you need help.

![Screenshot](/money-planet-crust/auth-client.png)

Optionally navigate to "users" and create a new user that we will use when logging in through the mobile application.

I decided to make a new user since my root user has a complex password, and I didn't want to deal with that.
Making a new user and then revoking its access was the laziest solution I could think of; we're programmers, after all.

![Screenshot](/money-planet-crust/auth-user.png)

# Tweaking the mobile app

Next on our checklist is the mobile application.

We'll need to do a few extra modifications on the authentication portion as I was getting network and certificate errors.
I couldn't figure it out in a timely manner I decided to write my OAuth2 client since that one should work just fine for our needs.

## Updating the environment

Before we do anything, open up the `.env` file that should already exist.
If it doesn't, refer to the [previous post]({{< ref "money" >}}) post to see how that is done.

Change all of the values except for `APP_NAME`, `DOMAIN`, `AUTH_REDIRECT_URL`, and `DEFAULT_PROFILE_PICTURE` -- those should remain the same.
The rest of the values need to change since we moved to a different instance, and they will be different.

Refer to the [previous post]({{< ref "money" >}}) for details on where you can find the values, but the TL;DR version is here:

* `API_DOMAIN` is the URL to your instance, such as `something.cloud.planetcrust.net`
* `AUTH_CLIENT_ID` is the long number in the URL address in the auth client editor
* `AUTH_CLIENT_SCRET` is the value generated by the auth client
* `COMPOSE_NAMESPACE_ID` is the long number in the URL address in the namespace editor
* `COMPOSE_MODULE_TRANACTION_ID` is the long number in the URL address in the `transaction` module editor for the `money` namespace

## Changing the authentication flow

> **NOTE:** If you're reading this later on in the future, this might already work as-is.
> Try to run the mobile app to see if the auth flow goes through ok.
> If it works fine, you can skip this section.

The [Flutter AppAuth Plugin](https://pub.dev/packages/flutter_appauth) didn't want to cooperate with me -- it was throwing network errors and generic error codes.
I couldn't figure it out in a timely manner, so I decided to write my own little thing to get the OAuth2 flow sorted.
How hard can it be... right?

Here is the TL;DR of what needs to happen:
1. When we open up the login screen, we need to open up a web view pointed to the `/auth/oauth2/authorize` route.
2. When the user successfully authenticates with Corteza, we need to catch the parameters that Corteza sent over (namely the `code` and `state`).
3. Once we have the code and everything is validated, we need to exchange the code with an access token

### Updating dependencies

Add `flutter_webview_plugin` as we'll use it to open up the Corteza authentication page and remove `flutter_appauth` since we no longer need it.
At the end of this, my dependencies look like this:

```yaml
dependencies:
  flutter:
    sdk: flutter

  http: ^0.12.1

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.2
  flutter_spinkit: ^5.1.0
  flutter_dotenv: ^5.0.2
  flutter_webview_plugin: ^0.4.0

```

### Initializing the authentication flow

Here is the code that initializes the OAuth2 flow:

```dart
void initFlow() {
  _ww.launch(
    'https://${dotenv.env['API_DOMAIN']}/auth/oauth2/authorize' +
        '?response_type=code' +
        '&client_id=${dotenv.env['AUTH_CLIENT_ID']}' +
        '&state=$_stateKey' +
        '&scope=profile+api' +
        '&redirect_uri=${dotenv.env['AUTH_REDIRECT_URL']}',
    ignoreSSLErrors: true,
  );
}
```

`_ww` is the `FlutterWebviewPlugin` plugin instance we'll use to open up the Corteza authentication page.

`_stateKey` is used to identify this particular authentication flow.
You can use whatever value you desire, but this is usually a randomly generated value.

The rest of the values are taken from the `.env` file, so make sure everything is set correctly.

### Obtaining the access token

Once the user authenticates in the Corteza authentication page, we need to capture the `code` (provided by Corteza) and exchange it for the actual access token.
This code is a bit longer, so we'll break it down more.

Firstly, bind an `onUrlChanged` listener on the webview plugin:

```dart
_wwURLChange = _ww.onUrlChanged.listen(exchangeTokens);
```

In the listener, firstly make sure that we've received the appropriate URL and then extract the values out of it:

```dart
if (url.indexOf("oauthredirect") <= -1) {
  return;
}

_ww.close();

// Get the required params from the url
var parsed = parseRedirect(url);

if (parsed.state != _stateKey) {
  throw new Exception("request and response states don't match");
}
```

Next, exchange the `code` for the access token.
Since we're not using the default auth client prepared by Corteza, we need to specify that also.
This is done via the basic auth header (notice the `Authorization` header).

```dart
// Exchange OAuth2 bits
var rsp =
    await http.post('https://${dotenv.env['API_DOMAIN']}/auth/oauth2/token',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': ' application/json',
          // This indicates what auth client Corteza should use
          'Authorization': 'Basic ' +
              base64Encode(utf8.encode(
                  '${dotenv.env['AUTH_CLIENT_ID']}:${dotenv.env['AUTH_CLIENT_SECRET']}')),
        },
        encoding: Encoding.getByName('utf-8'),
        body: {
          "code": parsed.code,
          "grant_type": "authorization_code",
          "redirect_uri": dotenv.env['AUTH_REDIRECT_URL'],
        });
```

Once that's out of the way, we can verify and parse the response.
The response is a simple JSON object with the following parameters:

* `access_token`: the access token we need to use to authenticate requests,
* `email`: the email of the corresponding user,
* `expires_in`: the amount of time (in seconds) the access token is valid for
* `handle`: the handle of the corresponding user,
* `name`: the name of the corresponding user,
* `refresh_token`: the refresh token we can use to obtain a new access token,
* `refresh_token_expires_in`: the amount of time (in seconds) the access token is valid for,
* `roles`: the list of roles the corresponding user is a member of,
* `scope`: the scope we requested,
* `sub`: the userID of the corresponding user,
* `token_type`: the access token type.

Parse the JSON and update the state we prepared in the previous post:

```dart
// Don't do this in production; have errors make more sense
if (rsp.statusCode >= 400) {
  throw new Exception("something went wrong");
}

var c = Creds.fromJson(jsonDecode(rsp.body));
state.accessToken = c.accessToken;
state.refreshToken = c.refreshToken;
state.userID = c.userID;
```

Once everything is done, discard the webview and navigate to the `/tldr` screen as before:

```dart
dispose();
Navigator.pushReplacementNamed(context, '/tldr');
```

# The result

The application should work the same as it did before:
when the application starts, we are prompted to log in through Corteza.
You enter your login credentials and tap on login.

<img src="/money-planet-crust/mobile-login.jpg" style="max-height: 500px" />

After the login is successful, you are redirected to the TL;DR screen, where we can see our basic user info as well as the transactions we created earlier.

<img src="/money-planet-crust/mobile-tldr.jpg" style="max-height: 500px" />

# TODO

We didn't do much to the initial implementation since I was just faffing around with authentication-related issues.

Since the TODO list remains the same, I'll copy it over to here:

* **Error handling**: I didn't do much error handling so that some errors would crash the whole application.
  Errors should be handled appropriately, logged, and displayed to the user.
* **Live data**: Currently, data won't get automatically refreshed if it is changed in Corteza.
  Corteza currently doesn't provide WebSockets to indicate changes, so we could do some pooling until we implement it.
* **Send notifications**: We could add email or push notifications to notify users about special events.
* **Option to log transactions**: We could add an input inside the mobile application to add new transactions.
